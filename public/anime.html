<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aniplix - Anime Search</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #E1306C;
            --primary-light: #FD1D1D;
            --gradient: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
            --dark-bg: #0F0F0F;
            --darker-bg: #0A0A0A;
            --light-bg: #1E1E1E;
            --text-primary: #FFFFFF;
            --text-secondary: #AAAAAA;
            --accent-color: #3EA6FF;
            --glass-bg: rgba(30, 30, 30, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --success-color: #4CAF50;
            --warning-color: #FFC107;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.15;
            animation: float 15s infinite ease-in-out;
        }

        .circle-1 {
            width: 300px;
            height: 300px;
            background: #405DE6;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .circle-2 {
            width: 400px;
            height: 400px;
            background: #C13584;
            top: 60%;
            left: 70%;
            animation-delay: 3s;
        }

        .circle-3 {
            width: 250px;
            height: 250px;
            background: #FD1D1D;
            top: 30%;
            left: 50%;
            animation-delay: 6s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
            }
            50% {
                transform: translateY(-50px) translateX(50px);
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            text-decoration: none;
            color: inherit;
        }

        .logo:hover {
            transform: scale(1.02);
        }

        .logo-icon {
            width: 2.2rem;
            height: 2.2rem;
            animation: pulse 2s infinite;
            /* Color is set by SVG content or inherited if designed for currentColor */
        }
         .logo-icon { /* For SVG specific coloring, if needed */
            color: var(--primary-light); /* Example, if SVG uses currentColor */
        }


        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(225, 48, 108, 0.3);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 15px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
        }

        .header-action-secondary-btn {
            color: var(--accent-color);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .header-action-secondary-btn:hover {
            color: var(--primary-color);
            background-color: rgba(225, 48, 108, 0.1);
        }

        .header-action-secondary-btn i {
            font-size: 1rem;
        }


        .main-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .main-container:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .download-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 30px;
        }

        .input-group {
            position: relative;
        }

        .url-input {
            width: 100%;
            padding: 18px 25px;
            background: var(--light-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            color: var(--text-primary);
            font-size: 1.1rem;
            outline: none;
            transition: var(--transition);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .url-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(225, 48, 108, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .url-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .download-btn {
            background: var(--gradient);
            border: none;
            color: white;
            padding: 18px 35px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(225, 48, 108, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(225, 48, 108, 0.4);
        }

        .download-btn:hover::before {
            left: 100%;
        }

        .download-btn:active {
            transform: translateY(0);
        }
        
        .download-btn i {
            font-size: 1.2em;
        }

        #results {
            margin-top: 25px; /* Reduced margin */
            display: none;
        }

        #results.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .media-card {
            background: var(--light-bg);
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            flex-direction: column; /* Default to column for smaller screens */
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
            transition: var(--transition);
            padding: 20px;
            text-align: left;
        }

        @media (min-width: 768px) {
            .media-card {
                flex-direction: row; /* Side-by-side on larger screens */
                gap: 20px;
                align-items: flex-start;
            }
        }
        
        .media-snapshot {
            width: 150px;
            height: 225px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            flex-shrink: 0; /* Prevent image from shrinking */
        }

        @media (max-width: 767px) {
            .media-snapshot {
                width: 100%; /* Full width on smaller screens */
                max-width: 200px; /* Max width for consistency */
                height: auto;
                margin: 0 auto 15px auto; /* Center and add bottom margin */
            }
            .media-card {
                 text-align: center;
            }
        }


        .media-info {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Reduced gap */
            flex-grow: 1;
        }

        .media-title {
            font-size: 1.3rem;
            font-weight: 600;
            line-height: 1.4;
        }
        .media-title-small {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .download-options-container {
            margin-top: 15px;
        }
        .download-links-section {
            margin-bottom: 15px;
        }
        .links-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        .download-options {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .download-option, .download-option-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 10px 15px; /* Adjusted padding */
            border-radius: 10px;
            font-size: 0.9rem; /* Adjusted font size */
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex; /* Use inline-flex for button like behavior */
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative; /* For loader */
        }
        .download-option-button .btn-text { /* Class for text part of button */
            display: inline-block;
        }
        .download-option-button .btn-loader { /* Class for loader spinner */
            display: none; /* Hidden by default */
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--text-primary);
            animation: btn-spin 0.6s linear infinite;
            margin-left: 5px;
        }

        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }
        .download-option-button.resolving .btn-text {
            display: none;
        }
        .download-option-button.resolving .btn-loader {
            display: inline-block;
        }


        .download-option:hover, .download-option-button:hover:not(.resolving) {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(225, 48, 108, 0.2);
        }

        .download-option i, .download-option-button i {
            font-size: 1rem; /* Adjusted icon size */
        }
        .no-links {
            color: var(--text-secondary);
            font-style: italic;
        }
        .resolved-links-container a {
            margin-right: 10px; /* Space between resolved links */
            margin-bottom: 5px; /* Space if they wrap */
        }


        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center the content */
            /* gap: 25px; */ /* Removed explicit gap to let loader style handle it */
            /* margin: 40px 0; */ /* Removed explicit margin */
            width: 100%; /* Ensure it takes full width for centering */
            min-height: 200px; /* Give some space for the loader */
        }

        .loading.active {
            display: flex;
        }

        /* Book Loader Styles - Uiverse.io by Nawsome */
        .loader {
            --background: linear-gradient(135deg, #23C4F8, #275EFE);
            --shadow: rgba(39, 94, 254, 0.28);
            --text: #6C7486; /* Color for "Loading" text under the book */
            --page: rgba(255, 255, 255, 0.36);
            --page-fold: rgba(255, 255, 255, 0.52);
            --duration: 3s;
            width: 200px;
            height: 140px;
            position: relative;
            /* Removed box-shadow from here as it was being applied to .loading container */
        }
        .loader:before, .loader:after {
            --r: -6deg; content: ""; position: absolute; bottom: 8px; width: 120px; top: 80%;
            box-shadow: 0 16px 12px var(--shadow); transform: rotate(var(--r));
        }
        .loader:before { left: 4px; }
        .loader:after { --r: 6deg; right: 4px; }
        .loader div {
            width: 100%; height: 100%; border-radius: 13px; position: relative; z-index: 1;
            perspective: 600px; background-image: var(--background);
            box-shadow: 0 4px 6px var(--shadow); /* Added shadow here for the book itself */
        }
        .loader div ul { margin: 0; padding: 0; list-style: none; position: relative; }
        .loader div ul li {
            --r: 180deg; --o: 0; --c: var(--page);
            position: absolute; top: 10px; left: 10px; transform-origin: 100% 50%;
            color: var(--c); opacity: var(--o); transform: rotateY(var(--r));
            animation: page-flip var(--duration) ease infinite; /* Renamed animation for clarity */
        }
        .loader div ul li:nth-child(2) { --c: var(--page-fold); animation-name: page-flip-2; }
        .loader div ul li:nth-child(3) { --c: var(--page-fold); animation-name: page-flip-3; }
        .loader div ul li:nth-child(4) { --c: var(--page-fold); animation-name: page-flip-4; }
        .loader div ul li:nth-child(5) { --c: var(--page-fold); animation-name: page-flip-5; }
        .loader div ul li svg, .loader div ul li img { width: 90px; height: 120px; display: block; } /* Applied to SVG directly */
        .loader div ul li:first-child { --r: 0deg; --o: 1; }
        .loader div ul li:last-child { --o: 1; }
        .loader span { /* Styles the "Loading" text under the book */
            display: block; left: 0; right: 0; top: 100%; margin-top: 20px;
            text-align: center; color: var(--text);
            font-size: 1rem;
        }
        @keyframes page-flip-2 { 0% { transform: rotateY(180deg); opacity: 0; } 20% { opacity: 1; } 35%, 100% { opacity: 0; } 50%, 100% { transform: rotateY(0deg); } }
        @keyframes page-flip-3 { 15% { transform: rotateY(180deg); opacity: 0; } 35% { opacity: 1; } 50%, 100% { opacity: 0; } 65%, 100% { transform: rotateY(0deg); } }
        @keyframes page-flip-4 { 30% { transform: rotateY(180deg); opacity: 0; } 50% { opacity: 1; } 65%, 100% { opacity: 0; } 80%, 100% { transform: rotateY(0deg); } }
        @keyframes page-flip-5 { 45% { transform: rotateY(180deg); opacity: 0; } 65% { opacity: 1; } 80%, 100% { opacity: 0; } 95%, 100% { transform: rotateY(0deg); } }


        .error-message {
            display: none;
            background: rgba(225, 48, 108, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--text-primary);
            padding: 18px;
            border-radius: 15px;
            margin-top: 25px;
            text-align: center;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .error-message.active {
            display: block;
            animation: fadeIn 0.5s ease, shake 0.5s ease;
        }

        .error-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 50px;
        }

        .feature-card {
            background: var(--light-bg);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 18px;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--glass-border);
        }

        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            background: rgba(225, 48, 108, 0.1);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .feature-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .faq { margin-top: 60px; }
        .faq-item { margin-bottom: 15px; border-radius: 12px; overflow: hidden; background: var(--light-bg); }
        .faq-question { padding: 18px 25px; background: rgba(255,255,255,0.05); color: var(--text-primary); font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: var(--transition); }
        .faq-question:hover { background: rgba(255,255,255,0.08); }
        .faq-question::after { content: '+'; font-size: 1.3rem; transition: var(--transition); }
        .faq-question.active::after { content: '-'; }
        .faq-answer { padding: 0 25px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6; }
        .faq-question.active + .faq-answer { padding: 18px 25px; max-height: 500px; }

        .footer {
            margin-top: 80px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.95rem;
            padding: 30px 0;
            position: relative;
        }

        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--glass-border), transparent);
        }

        .creator {
            color: var(--accent-color);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .creator:hover {
            text-decoration: underline;
            color: var(--primary-color);
        }
        
        .social-links { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .social-link { color: var(--text-secondary); font-size: 1.2rem; transition: var(--transition); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); }
        .social-link:hover { color: var(--primary-color); background: rgba(225,48,108,0.1); transform: translateY(-3px); }

        /* Suggestions Section */
        #animeSuggestionsSection {
            margin-top: 40px;
            margin-bottom: 40px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            position: relative;
            display: inline-block;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
        }
        #suggestionsGrid {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 10px 0 20px 0; /* Add some padding for scrollbar and bottom space */
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--light-bg);
        }
        #suggestionsGrid::-webkit-scrollbar {
            height: 8px;
        }
        #suggestionsGrid::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 10px;
        }
        #suggestionsGrid::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
            border: 2px solid var(--light-bg);
        }
        .suggestion-card {
            background: var(--light-bg);
            border-radius: 15px;
            overflow: hidden;
            text-decoration: none;
            color: var(--text-primary);
            transition: var(--transition);
            flex: 0 0 auto; /* Prevent shrinking/growing */
            width: 180px; /* Fixed width for cards in a row */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .suggestion-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .suggestion-card img {
            width: 100%;
            height: 250px; /* Taller for poster-like appearance */
            object-fit: cover;
            border-bottom: 1px solid var(--glass-border);
        }
        .suggestion-card-info {
            padding: 15px;
            text-align: center;
        }
        .suggestion-card-title {
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        #suggestionsLoader { /* Container for suggestions loader */
            display: none; /* Initially hidden */
            width: 100%;
            padding: 40px 0;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #suggestionsLoader.active {
            display: flex;
        }
        #suggestionsErrorMessageDiv { /* Container for suggestions error message */
            /* Uses general .error-message styles */
        }


        @media (max-width: 992px) {
            .main-container { padding: 30px; }
            .header { flex-direction: column; gap: 20px; text-align: center; }
            .logo { justify-content: center; }
            .header-actions { justify-content: center; }
        }
        @media (max-width: 768px) {
            .main-container { padding: 25px; }
            .logo-text { font-size: 1.5rem; }
            .download-btn { padding: 16px 25px; }
            .media-title { font-size: 1.1rem; }
            .url-input { padding: 16px 20px; font-size: 1rem; }
            #suggestionsGrid { gap: 15px; }
            .suggestion-card { width: 150px; }
            .suggestion-card img { height: 210px; }
        }
         @media (max-width: 480px) {
            .tagline { display: none; } /* Hide tagline on very small screens */
            .header-actions { gap: 10px; }
            .header-action-secondary-btn { padding: 6px 10px; font-size: 0.85rem; }
            .suggestion-card { width: 130px; }
            .suggestion-card img { height: 180px; }
            .suggestion-card-title { font-size: 0.85rem; }
        }

    </style>
</head>
<body>
    <script>
        if (localStorage.getItem('isLoggedInAniplix') !== 'true') {
            window.location.href = '/login.html';
        }
    </script>

    <div class="bg-animation">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>

    <header class="header">
        <a href="/anime.html" class="logo">
            <img src="/media/logo.svg" alt="Aniplix Logo" class="logo-icon">
            <span class="logo-text">Aniplix</span>
        </a>
        <div class="header-actions">
            <span class="tagline">Your Anime Universe</span>
            <a href="/random" class="header-action-secondary-btn">
                <i class="fas fa-random"></i> Random Anime
            </a>
            <a href="/new" class="header-action-secondary-btn">
                <i class="fas fa-fire"></i> New Releases
            </a>
        </div>
    </header>

    <div class="main-container">
        <h1 class="section-title" style="text-align: center; margin-bottom: 30px; display: block;">Search Your Favorite Anime</h1>
        <form id="searchForm" class="download-form">
            <div class="input-group">
                <input type="text" id="animename" class="url-input" placeholder="e.g., Solo Leveling or Naruto epi 10 (episode defaults to 1)" required>
            </div>
            <button type="submit" class="download-btn">
                <i class="fas fa-search"></i> Search Anime
            </button>
        </form>

        <div class="loading" id="loadingState">
            <div class="loader">
                <div>
                    <ul>
                        <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                        <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                        <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                        <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                        <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                        <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                    </ul>
                </div>
                <span>Loading Anime...</span>
            </div>
        </div>

        <div id="results">
            <!-- Search results will be populated here -->
        </div>
        <div id="errorMessage" class="error-message">
             <i class="fas fa-exclamation-circle error-icon"></i>
            <span id="errorText"></span>
        </div>

        <!-- Suggestions Section -->
        <div id="animeSuggestionsSection">
            <h2 class="section-title">Popular Suggestions For You</h2>
            <div class="loading" id="suggestionsLoader"> <!-- This is the loader for suggestions -->
                 <div class="loader"> <!-- Actual book animation -->
                    <div>
                        <ul>
                            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
                        </ul>
                    </div>
                    <span>Loading suggestions...</span>
                </div>
            </div>
            <div id="suggestionsGrid">
                <!-- Suggestion cards will be populated here -->
            </div>
             <div id="suggestionsErrorMessageDiv" class="error-message">
                 <i class="fas fa-exclamation-circle error-icon"></i>
                 <span id="suggestionsErrorText"></span>
            </div>
        </div>


        <div class="features">
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                <h3 class="feature-title">Lightning Fast</h3>
                <p class="feature-desc">Get your anime info and links quickly and efficiently.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-layer-group"></i></div>
                <h3 class="feature-title">Vast Selection</h3>
                <p class="feature-desc">Access a wide range of anime series and episodes.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-magic"></i></div>
                <h3 class="feature-title">User Friendly</h3>
                <p class="feature-desc">Enjoy a smooth and intuitive browsing experience.</p>
            </div>
        </div>

        <div class="faq">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <div class="faq-item">
                <div class="faq-question">How do I search for an anime?</div>
                <div class="faq-answer">
                    <p>Simply type the anime name and optionally the episode number (e.g., "Naruto 5" or "One Piece epi 100") into the search bar and click "Search Anime". If no episode is specified, it defaults to episode 1.</p>
                </div>
            </div>
            <div class="faq-item">
                <div class="faq-question">What are "Resolve" buttons?</div>
                <div class="faq-answer">
                    <p>Some download links require an extra step to get the direct file. Clicking "Resolve" will fetch the final MP4 or Kwik download links for you.</p>
                </div>
            </div>
            <div class="faq-item">
                <div class="faq-question">Is this service free?</div>
                <div class="faq-answer">
                    <p>Yes, Aniplix is a free tool to help you find anime information and download links.</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; <span id="currentYear"></span> Aniplix. Created by <a href="https://github.com/lakshay-art" target="_blank" class="creator">Lakshay Chhabra (Blue Demon)</a>.</p>
        <div class="social-links">
            <a href="#" class="social-link"><i class="fab fa-github"></i></a>
            <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
            <a href="#" class="social-link"><i class="fab fa-discord"></i></a>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('searchForm');
            const animenameInput = document.getElementById('animename');
            const resultsDiv = document.getElementById('results');
            const loadingState = document.getElementById('loadingState');
            const errorMessageDiv = document.getElementById('errorMessage');
            const errorTextSpan = document.getElementById('errorText');

            // FAQ Accordion
            const faqQuestions = document.querySelectorAll('.faq-question');
            faqQuestions.forEach(question => {
                question.addEventListener('click', () => {
                    question.classList.toggle('active');
                });
            });
             // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            searchForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const query = animenameInput.value.trim();

                resultsDiv.classList.remove('active');
                resultsDiv.innerHTML = '';
                errorMessageDiv.classList.remove('active');
                errorTextSpan.textContent = '';

                if (!query) {
                    errorTextSpan.textContent = 'Please enter an anime name.';
                    errorMessageDiv.classList.add('active');
                    return;
                }
                
                let animeNameForAPI;
                let episodeForAPI = "1"; // Default to 1

                // Regex to capture anime name and optional episode number
                // Allows for formats: "Anime Name 123", "Anime Name epi 123", "Anime Name episode 123"
                // Or just "Anime Name" (will default episode to 1)
                const match = query.match(/^(.*?)(?:\s+(?:e[ps]?i?(?:sode)?)?\s*(\d+))?$/i);

                if (match) {
                    animeNameForAPI = match[1].trim(); // Everything before the episode part
                    if (match[2]) { // If an episode number was captured
                        episodeForAPI = match[2];
                    }
                } else { // Should not happen if query is not empty, but as a fallback
                    animeNameForAPI = query;
                }
                
                if (!animeNameForAPI) {
                    errorTextSpan.textContent = 'Please enter a valid anime name.';
                    errorMessageDiv.classList.add('active');
                    return;
                }
                if (parseInt(episodeForAPI) <= 0) {
                    errorTextSpan.textContent = 'Episode number must be a positive integer.';
                    errorMessageDiv.classList.add('active');
                    return;
                }


                loadingState.classList.add('active');

                try {
                    const response = await fetch(`/api/search-anime?animename=${encodeURIComponent(animeNameForAPI)}&episode=${encodeURIComponent(episodeForAPI)}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || `Error ${response.status}`);
                    }
                    displayResults(data);
                } catch (error) {
                    console.error('Search error:', error);
                    errorTextSpan.textContent = error.message || 'Failed to fetch anime details. Please try again.';
                    errorMessageDiv.classList.add('active');
                } finally {
                    loadingState.classList.remove('active');
                }
            });

            function displayResults(data) {
                resultsDiv.innerHTML = ''; // Clear previous results
                resultsDiv.classList.add('active');
                errorMessageDiv.classList.remove('active');

                const card = document.createElement('div');
                card.className = 'media-card';

                let snapshotHTML = '';
                if (data.snapshot) {
                    snapshotHTML = `<img src="/api/image-proxy?url=${encodeURIComponent(data.snapshot)}" alt="${data.title} Snapshot" class="media-snapshot" onerror="this.onerror=null; this.src='https://placehold.co/150x225.png?text=No+Image'; this.setAttribute('data-ai-hint', 'anime art');" referrerpolicy="no-referrer" data-ai-hint="anime art">`;
                } else {
                    snapshotHTML = `<img src="https://placehold.co/150x225.png?text=No+Image" alt="No snapshot available" class="media-snapshot" data-ai-hint="anime art">`;
                }
                
                const mediaInfoDiv = document.createElement('div');
                mediaInfoDiv.className = 'media-info';

                mediaInfoDiv.innerHTML = `
                    <h2 class="media-title">${data.title || 'N/A'}</h2>
                    <p class="media-title-small">Episode: ${data.episode || 'N/A'}</p>
                `;
                
                const downloadsContainer = document.createElement('div');
                downloadsContainer.className = 'download-options-container';

                ['sub', 'dub'].forEach(type => {
                    if (data.links && data.links[type] && Object.keys(data.links[type]).length > 0) {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'download-links-section';
                        
                        const header = document.createElement('h3');
                        header.className = 'links-header';
                        header.textContent = type === 'sub' ? 'Subtitled Links:' : 'Dubbed Links:';
                        sectionDiv.appendChild(header);

                        const optionsDiv = document.createElement('div');
                        optionsDiv.className = 'download-options';

                        for (const quality in data.links[type]) {
                            const linkUrl = data.links[type][quality];
                            if (quality.endsWith('_download')) { // These are pahe.win links needing resolution
                                const qualityLabel = quality.replace('_download', ''); // e.g., 360p
                                const resolveButtonContainer = document.createElement('div'); // Container for button and resolved links
                                resolveButtonContainer.className = 'resolve-button-container'; // Add class if specific styling needed
                                
                                const resolveButton = document.createElement('button');
                                resolveButton.className = 'download-option-button';
                                
                                const btnText = document.createElement('span');
                                btnText.className = 'btn-text';
                                btnText.textContent = `Resolve ${qualityLabel}`;
                                
                                const btnLoader = document.createElement('span');
                                btnLoader.className = 'btn-loader';

                                resolveButton.appendChild(btnText);
                                resolveButton.appendChild(btnLoader);
                                
                                resolveButton.addEventListener('click', async () => {
                                    resolveButton.classList.add('resolving'); // Show loader
                                    resolveButton.disabled = true;
                                    
                                    try {
                                        const resolveResponse = await fetch(`/api/resolve-download-link?url=${encodeURIComponent(linkUrl)}`);
                                        const resolvedData = await resolveResponse.json();
                                        
                                        resolveButtonContainer.innerHTML = ''; // Clear the button

                                        if (!resolveResponse.ok) {
                                             throw new Error(resolvedData.message || `Failed to resolve ${qualityLabel}`);
                                        }

                                        const resolvedLinksDiv = document.createElement('div');
                                        resolvedLinksDiv.className = 'resolved-links-container';

                                        let linkAdded = false;
                                        if (resolvedData.mp4Link) {
                                            const mp4LinkEl = document.createElement('a');
                                            mp4LinkEl.href = resolvedData.mp4Link;
                                            mp4LinkEl.textContent = `MP4 (${qualityLabel})`;
                                            mp4LinkEl.className = 'download-option';
                                            mp4LinkEl.target = '_blank';
                                            resolvedLinksDiv.appendChild(mp4LinkEl);
                                            linkAdded = true;
                                        }
                                        if (resolvedData.kwikLink) {
                                            const kwikLinkEl = document.createElement('a');
                                            kwikLinkEl.href = resolvedData.kwikLink;
                                            kwikLinkEl.textContent = `Kwik (${qualityLabel})`;
                                            kwikLinkEl.className = 'download-option';
                                            kwikLinkEl.target = '_blank';
                                            resolvedLinksDiv.appendChild(kwikLinkEl);
                                            linkAdded = true;
                                        }

                                        if (!linkAdded) {
                                            resolvedLinksDiv.textContent = `No direct links found for ${qualityLabel}.`;
                                            resolvedLinksDiv.className += ' no-links';
                                        }
                                        resolveButtonContainer.appendChild(resolvedLinksDiv);

                                    } catch (err) {
                                        console.error('Resolve error:', err);
                                        resolveButtonContainer.innerHTML = `<span class="no-links">Error resolving ${qualityLabel}.</span>`;
                                    }
                                });
                                resolveButtonContainer.appendChild(resolveButton);
                                optionsDiv.appendChild(resolveButtonContainer);
                            }
                            // Streaming links (non _download) are now omitted
                        }
                        if (optionsDiv.children.length === 0) {
                            const noLinksMsg = document.createElement('span');
                            noLinksMsg.className = 'no-links';
                            noLinksMsg.textContent = 'No download links available for this type.';
                            optionsDiv.appendChild(noLinksMsg);
                        }
                        sectionDiv.appendChild(optionsDiv);
                        downloadsContainer.appendChild(sectionDiv);
                    }
                });
                
                if (downloadsContainer.children.length === 0) {
                     const noLinksMsg = document.createElement('p');
                     noLinksMsg.className = 'no-links';
                     noLinksMsg.textContent = 'No download links found for this anime/episode.';
                     downloadsContainer.appendChild(noLinksMsg);
                }

                mediaInfoDiv.appendChild(downloadsContainer);
                
                card.innerHTML = snapshotHTML; // Add snapshot first
                card.appendChild(mediaInfoDiv); // Then add info
                resultsDiv.appendChild(card);
            }

            // --- Suggestions ---
            const suggestionsLoader = document.getElementById('suggestionsLoader');
            const suggestionsGrid = document.getElementById('suggestionsGrid');
            const suggestionsErrorMessageDiv = document.getElementById('suggestionsErrorMessageDiv');
            const suggestionsErrorText = document.getElementById('suggestionsErrorText');

            async function fetchAndDisplaySuggestions() {
                if (!suggestionsLoader || !suggestionsGrid || !suggestionsErrorMessageDiv) return;

                suggestionsGrid.innerHTML = '';
                suggestionsErrorMessageDiv.classList.remove('active');
                suggestionsErrorText.textContent = '';
                suggestionsLoader.classList.add('active');

                try {
                    const response = await fetch('/api/anime-suggestions');
                    const suggestions = await response.json();

                    if (!response.ok) {
                        throw new Error(suggestions.message || 'Failed to load suggestions.');
                    }

                    if (suggestions && suggestions.length > 0) {
                        suggestions.forEach(anime => {
                            const cardLink = document.createElement('a');
                            cardLink.href = `/new-detail.html?url=${encodeURIComponent(anime.link)}`;
                            cardLink.className = 'suggestion-card';

                            const img = document.createElement('img');
                            img.src = `/api/image-proxy?url=${encodeURIComponent(anime.image)}`;
                            img.alt = anime.englishName;
                            img.onerror = function() { this.onerror=null; this.src='https://placehold.co/180x250.png?text=N/A'; this.setAttribute('data-ai-hint', 'anime art'); };
                            img.setAttribute('data-ai-hint', 'anime art');
                            img.referrerPolicy = 'no-referrer';


                            const infoDiv = document.createElement('div');
                            infoDiv.className = 'suggestion-card-info';

                            const titleSpan = document.createElement('span');
                            titleSpan.className = 'suggestion-card-title';
                            titleSpan.textContent = anime.englishName || 'Name not available';

                            infoDiv.appendChild(titleSpan);
                            cardLink.appendChild(img);
                            cardLink.appendChild(infoDiv);
                            suggestionsGrid.appendChild(cardLink);
                        });
                    } else {
                        suggestionsErrorText.textContent = 'No suggestions available at the moment.';
                        suggestionsErrorMessageDiv.classList.add('active');
                    }

                } catch (error) {
                    console.error('Suggestions fetch error:', error);
                    suggestionsErrorText.textContent = error.message || 'Could not load suggestions. Please try again later.';
                    suggestionsErrorMessageDiv.classList.add('active');
                } finally {
                    suggestionsLoader.classList.remove('active');
                }
            }

            fetchAndDisplaySuggestions(); // Load suggestions on page load
        });
    </script>
</body>
</html>
